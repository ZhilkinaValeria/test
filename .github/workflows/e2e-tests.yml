name: E2E Tests (Selenium + Python)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install selenium pytest

      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/googlechrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/googlechrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt update
          sudo apt install -y google-chrome-stable

      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\ B\.[0-9]+\.[0-9]+' | head -1)
          CHROME_MAJOR=$(echo "$CHROME_VERSION" | cut -d. -f1)
          DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_$CHROME_MAJOR")
          wget -O chromedriver.zip "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$DRIVER_VERSION/linux64/chromedriver-linux64.zip"
          unzip chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Start Vite server if frontend exists
        run: |
          if [ -f package.json ]; then
            npm install
            npm run dev -- --port 8000 --host 0.0.0.0 > vite.log 2>&1 &
            npx wait-on http://127.0.0.1:8000 --timeout 90000
          else
            echo "No package.json found - skipping Vite server start"
          fi

      - name: Patch Zhilkina test (headless + port 8000)
        run: |
          cat > patch.py <<'EOF'
          with open("zhilkina_first_test.py", encoding="utf-8") as f:
              content = f.read()
          \ncontent = content.replace("http://localhost:3000", "http://localhost:8000")
          if "def setup(self):" in content:
              lines = content.splitlines()
              new_lines = []
              inserted = False
              for line in lines:
                  if "def setup(self):" in line and not inserted:
                      indent = " " * (len(line) - len(line.lstrip()))
                      new_lines.append(line)
                      new_lines += [
                          f"{indent}    from selenium.webdriver.chrome.options import Options",
                          f"{indent}    opts = Options()",
                          f"{indent}    opts.add_argument('--headless=new')",
                          f"{indent}    opts.add_argument('--no-sandbox')",
                          f"{indent}    opts.add_argument('--disable-dev-shm-usage')",
                          f"{indent}    opts.add_argument('--disable-gpu')",
                          f"{indent}    self.driver = webdriver.Chrome(options=opts)",
                      ]
                      inserted = True
                  elif 'self.driver = webdriver.Chrome()' in line and inserted:
                      continue
                  else:
                      new_lines.append(line)
              content = "\n".join(new_lines)
          with open("zhilkina_first_test_ci.py", "w", encoding="utf-8") as f:
              f.write(content)
          EOF
          python patch.py

      - name: Run E2E tests
        run: |
          mkdir -p screenshots
          python -m pytest zhilkina_first_test_ci.py -v --tb=short || true
          python Berezhnaya_SECOND.py || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            screenshots/
            *.png
            *.log
            vite.log
          if-no-files-found: warn
